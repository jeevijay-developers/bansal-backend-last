<%- include('../layouts/header') %>

<div class="content-body">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h3 class="card-title-2">
              <% let activeType = req.params.course_type; %>
              <!-- Course Filter Buttons -->
              <a href="/admin/course-list/all" class="btn <%= activeType === 'all' ? 'btn-primary' : 'btn-default' %> mr-2">All Course</a>
              <a href="/admin/course-list/active" class="btn <%= activeType === 'active' ? 'btn-primary' : 'btn-default' %> mr-2">Active Course</a>
              <a href="/admin/course-list/inactive" class="btn <%= activeType === 'inactive' ? 'btn-primary' : 'btn-default' %> mr-2">Inactive Course</a>
              <a href="/admin/course-list/paid" class="btn <%= activeType === 'paid' ? 'btn-primary' : 'btn-default' %> mr-2">Paid Course</a>
              <a href="/admin/course-list/free" class="btn <%= activeType === 'free' ? 'btn-primary' : 'btn-default' %> mr-2">Free Course</a>
              <a href="/admin/course-list/online" class="btn <%= activeType === 'online' ? 'btn-primary' : 'btn-default' %> mr-2">Online Course</a>
              <a href="/admin/course-list/offline" class="btn <%= activeType === 'offline' ? 'btn-primary' : 'btn-default' %> mr-2">Offline Course</a>
              <a href="/admin/course-list/trashed" class="btn <%= activeType === 'trashed' ? 'btn-danger' : 'btn-default' %> mr-2">Deleted Course</a>
            </h3>

            <div class="row">
              <div class="col-12 text-end">
                <a class="btn btn-info btn-sm" href="<%= create_url %>">
                  <i class="fas fa-plus"></i>
                </a>
                <button type="button" id="backButton" class="btn btn-primary btn-sm">
                  <i class="fa fa-arrow-left"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="card-body">
            <% if (!customers || customers.length === 0) { %>
              <div class="col-12 text-center text-muted py-5">
                No course found.
              </div>
            <% } else { %>
              <!-- Sortable Container -->
              <div id="sortable" class="row">
                <% customers.forEach((course) => { %>
                  <div class="col-md-4 mb-3 course-item" data-id="<%= course.id %>">
                    <div class="border card mb-4 shadow-sm border rounded-4 overflow-hidden">
                      <div class="card-body p-4">
                        <div class="d-flex justify-content-between flex-wrap mb-16">
                          <div>
                            <p class="mb-1 text-muted">
                              <strong><%= course.category_name %></strong>
                              <small>(<%= course.class_name %>)</small>
                            </p>
                          </div>
                          <div class="text-end">
                            <% if (course.status == 1) { %>
                              <span class="badge bg-success">Active</span>
                            <% } else { %>
                              <span class="badge bg-danger">Inactive</span>
                            <% } %>
                          </div>
                        </div>
                        <hr />
                        <h5 class="fw-bold text-primary mb-3 d-block w-100">
                          <a href="/admin/course-show/<%= course.id %>" class="text-decoration-none text-dark">
                            <%= course.course_name %>
                          </a>
                        </h5>
                        <div class="row align-items-center">
                          <div class="col-md-4">
                            <img src="<%= publicUrl + course.image %>" alt="<%= course.slug %>" class="img-fluid rounded-3 w-100" style="aspect-ratio: 1 / 1; object-fit: cover" />
                          </div>
                          <div class="col-md-8 mt-3 mt-md-0">
                            <h6 class="text-success">₹ <%= course.offer_price %></h6>
                            <div class="mt-3">
                              <a href="/admin/course-show/<%= course.id %>" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-eye"></i>
                              </a>

                              <% if (activeType === 'trashed') { %>
                                <a href="/admin/course-restore/<%= course.id %>" class="btn btn-outline-success btn-sm me-2" onclick="return confirm('Are you sure you want to restore this item?');">
                                  <i class="fas fa-undo"></i> Restore
                                </a>
                                <a href="/admin/course-permanent-delete/<%= course.id %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to permanently delete this item?');">
                                  <i class="fas fa-trash"></i> Delete
                                </a>
                              <% } else { %>
                                <a href="/admin/course-edit/<%= course.id %>" class="btn btn-outline-warning btn-sm me-2">
                                  <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="/admin/course-delete/<%= course.id %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?');">
                                  <i class="fas fa-trash"></i>
                                </a>
                              <% } %>
                            </div>

                            <% if (activeType === 'trashed') { %>
                              <span class="badge badge-danger mt-3">Deleted at <%= course.deleted_at %></span>
                            <% } %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>

              <!-- Save Order Button -->
              <div class="text-end mt-3">
                <button id="saveOrder" class="btn btn-success btn-sm">Save Sort Order</button>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../layouts/footer') %>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- jQuery UI (adds .sortable and other UI functions) -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<style>
  .ui-state-highlight {
  height: 200px;
  background-color: #e9ecef;
  border: 2px dashed #007bff;
  margin-bottom: 1rem;
}
</style>
<!-- Drag & Drop Script -->
<script>
  $(function () {
    $('#sortable').sortable({
      placeholder: 'ui-state-highlight'
    });

    $('#saveOrder').on('click', function () {
      const order = [];
      $('.course-item').each(function (index) {
        order.push({
          id: $(this).data('id'),
          sort_order: index + 1
        });
      });

      $.ajax({
        url: '/admin/course-sort-order',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ order }),
        success: function (res) {
          alert('Sort order updated successfully!');
          location.reload();
        },
        error: function () {
          alert('Error updating sort order.');
        }
      });
    });
  });
</script>
<script>
  $(function () {
    $("#sortable").sortable({
      placeholder: "ui-state-highlight",
      items: ".course-item"
    });
  });
</script>
<!-- Highlight style -->
<style>
  .ui-state-highlight {
    height: 150px;
    background-color: #e9ecef;
    border: 2px dashed #007bff;
    margin-bottom: 1rem;
  }
</style>
<script>
  $(function () {
    if ($.fn.sortable) {
      $('#sortable').sortable({
        placeholder: 'ui-state-highlight',
        items: '.course-item'
      });
    } else {
      console.error("❌ jQuery UI not loaded. $('#sortable').sortable() is undefined.");
    }
  });
</script>