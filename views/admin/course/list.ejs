<%- include('../layouts/header') %>

<style>
  /* Card styling */
  .card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border-radius: 10px;
  }
  
  .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px 10px 0 0 !important;
    padding: 1.25rem;
  }
  
  .card-header h3 {
    color: white !important;
    margin: 0;
  }
  
  /* Filter buttons */
  .card-header .btn {
    border: 2px solid white;
    font-weight: 600;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
  }
  
  .card-header .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  
  .card-header .btn-primary {
    background: white;
    color: #667eea;
  }
  
  .card-header .btn-default {
    background: transparent;
    color: white;
  }
  
  /* Course cards */
  .course-item {
    transition: all 0.3s ease;
  }
  
  .course-item .card {
    height: 100%;
    transition: all 0.3s ease;
  }
  
  .course-item .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  
  .course-item img {
    transition: transform 0.3s ease;
  }
  
  .course-item:hover img {
    transform: scale(1.05);
  }
  
  /* Badges */
  .badge {
    padding: 0.35em 0.65em;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  /* Action buttons */
  .btn-sm {
    transition: all 0.3s ease;
  }
  
  .btn-sm:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* Bulk action buttons */
  #bulkDeleteBtn,
  #bulkRestoreBtn,
  #exportBtn {
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  #bulkDeleteBtn:hover:not(:disabled),
  #bulkRestoreBtn:hover:not(:disabled),
  #exportBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  #bulkDeleteBtn:disabled,
  #bulkRestoreBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* View More button */
  #viewMoreBtn {
    font-weight: 600;
    padding: 0.75rem 2rem;
    font-size: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
  }
  
  #viewMoreBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
  }
  
  /* Hidden courses */
  .course-item.hidden {
    display: none;
  }
  
  /* Loading animation */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }
</style>

  <div class="content-body">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title-2">
                <% let activeType=req.params.course_type; %>
                  <!-- Course Filter Buttons -->
                  <a href="/admin/course-list/all"
                    class="btn <%= activeType === 'all' ? 'btn-primary' : 'btn-default' %> mr-2">All Courses</a>
                  <a href="/admin/course-list/active"
                    class="btn <%= activeType === 'active' ? 'btn-primary' : 'btn-default' %> mr-2">Active Course</a>
                  <a href="/admin/course-list/inactive"
                    class="btn <%= activeType === 'inactive' ? 'btn-primary' : 'btn-default' %> mr-2">Inactive
                    Course</a>
                  <a href="/admin/course-list/paid"
                    class="btn <%= activeType === 'paid' ? 'btn-primary' : 'btn-default' %> mr-2">Paid Course</a>
                  <a href="/admin/course-list/free"
                    class="btn <%= activeType === 'free' ? 'btn-primary' : 'btn-default' %> mr-2">Free Course</a>
                  <a href="/admin/course-list/online"
                    class="btn <%= activeType === 'online' ? 'btn-primary' : 'btn-default' %> mr-2">Online Course</a>
                  <a href="/admin/course-list/offline"
                    class="btn <%= activeType === 'offline' ? 'btn-primary' : 'btn-default' %> mr-2">Offline Course</a>
                  <a href="/admin/course-list/trashed"
                    class="btn <%= activeType === 'trashed' ? 'btn-danger' : 'btn-default' %> mr-2">Deleted Course</a>
              </h3>

              <div class="row">
                <div class="col-12 text-end">
                  <a class="btn btn-info btn-sm" href="<%= create_url %>">
                    <i class="fas fa-plus"></i>
                  </a>
                  <button type="button" id="backButton" class="btn btn-primary btn-sm">
                    <i class="fa fa-arrow-left"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="card-body">
              <% if (!customers || customers.length===0) { %>
                <div class="col-12 text-center text-muted py-5">
                  No course found.
                </div>
                <% } else { %>
                  <!-- <div class="text-end my-2">
                <button id="saveOrder" class="btn btn-success btn-sm">Save Sort Order</button>
              </div> -->
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center">
                      <input type="checkbox" id="selectAll" class="me-2"> Select All

                      <% if (activeType==='trashed' ) { %>
                        <button id="bulkRestoreBtn" class="btn btn-success btn-sm ms-2" disabled>For Bulk
                          Restore</button>
                        <% } else { %>
                          <button id="bulkDeleteBtn" class="btn btn-danger btn-sm ms-2" disabled>For Bulk
                            Delete</button>
                          <% } %>
                    </div>

                    <!-- Right: Save Sort Order -->
                    <!-- <div class="text-end">
    <button id="saveOrder" class="btn btn-success btn-sm">Save Sort Order</button>
  </div> -->

                    <% if (permissions.includes('Course Export')) { %>

                      <a href="#" id="exportBtn" class="btn btn-success btn-sm">
                        <i class="fas fa-file-export"></i> Export Courses
                      </a>
                      <% } %>


                  </div>
                  <div id="sortable" class="row">
                    <% customers.forEach((course, index)=> { %>
                      <div class="col-md-4 mb-3 course-item <%= index >= 6 ? 'hidden' : '' %>" data-id="<%= course.id %>">
                        <div class="border card mb-4 shadow-sm border rounded-4 overflow-hidden">
                          <div class="card-body p-3" style="cursor:pointer">
                            <input type="checkbox" class="bulk-checkbox me-2" value="<%= course.id %>">
                            <div class="d-flex justify-content-between flex-wrap mb-16">
                              <div>
                                <div class="mb-1 text-muted d-flex" style="gap:5px">
                                  <div>
                                    <div><strong>
                                        <%= course.category_name %>
                                      </strong></div>
                                    <small class="text-danger">Sort No : <%= course.course_serial_no %></small>
                                  </div>

                                  <small>(<%= course.class_name %>)</small>
                                </div>
                              </div>
                              <div class="text-end">
                                <% if (course.status==1) { %>
                                  <span class="badge bg-success">Active</span>
                                  <% } else { %>
                                    <span class="badge bg-danger">Inactive</span>
                                    <% } %>
                              </div>
                            </div>
                            <hr />
                            <h5 class="fw-bold text-primary mb-3 d-block w-100">
                              <a href="/admin/course-show/<%= course.id %>" class="text-decoration-none text-dark"
                                style="font-size: 18px;">
                                <img src="<%= publicUrl + course.image %>" alt="<%= course.slug %>"
                                  class="img-fluid rounded-3" style="    width: 50px;
    height: 50px;
    margin-right: 10px;" />
                                <%= course.course_name %>
                              </a>
                            </h5>
                            <div class="align-items-center">


                              <div class="mb-2">
                                <% if (course.batch_type==='online' ) { %>
                                  <span class="badge bg-primary me-1">Online</span>
                                  <% } else { %>
                                    <span class="badge bg-secondary me-1">Offline</span>
                                    <% } %>

                                      <% if (course.is_universal==='yes' ) { %>
                                        <span class="badge bg-success me-1">Universal</span>
                                        <% } %>

                                          <% if (course.course_type==='paid' ) { %>
                                            <span class="badge bg-warning text-dark">Paid</span>
                                            <% } else { %>
                                              <span class="badge bg-info text-dark">Free</span>
                                              <% } %>
                              </div>

                              <div class="mt-3 mt-md-0 d-flex" style="align-items: center;
    justify-content: space-between;">
                                <div class="mb-2 mt-3" style="align-items: center;
    justify-content: space-between;">
                                  <h6 class="text-success mb-0">₹ <%= course.offer_price %>
                                  </h6>

                                  <% if (course.price> course.offer_price) { %>
                                    <small class="text-muted text-decoration-line-through">₹ <%= course.price %></small>

                                    <% if (course.discount_type==='percentage' ) { %>
                                      <small class="ms-2 text-danger">(<%= course.discount %>% OFF)</small>
                                      <% } else if (course.discount_type==='price' ) { %>
                                        <small class="ms-2 text-danger">(₹<%= course.discount %> OFF)</small>
                                        <% } %>
                                          <% } %>
                                </div>
                                <div class="">
                                  <a href="/admin/course-show/<%= course.id %>"
                                    class="btn btn-outline-primary btn-sm me-2">
                                    <i class="fas fa-eye"></i>
                                  </a>

                                  <% if (activeType==='trashed' ) { %>
                                    <a href="/admin/course-restore/<%= course.id %>"
                                      class="btn btn-outline-success btn-sm me-2"
                                      onclick="return confirm('Are you sure you want to restore this item?');">
                                      <i class="fas fa-undo"></i> Restore
                                    </a>
                                    <a href="/admin/course-permanent-delete/<%= course.id %>"
                                      class="btn btn-outline-danger btn-sm"
                                      onclick="return confirm('Are you sure you want to permanently delete this item?');">
                                      <i class="fas fa-trash"></i> Delete
                                    </a>
                                    <% } else { %>

                                      <!-- <a href="/admin/course-edit/<%= course.id %>" class="btn btn-outline-warning btn-sm me-2">
                                  <i class="fas fa-pencil-alt"></i>
                                </a>
                                <a href="/admin/course-delete/<%= course.id %>" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?');">
                                  <i class="fas fa-trash"></i>
                                </a> -->

                                      <% if (course.isEdit) { %>
                                        <a href="/admin/course-edit/<%= course.id %>"
                                          class="btn btn-outline-warning btn-sm me-2">
                                          <i class="fas fa-pencil-alt"></i>
                                        </a>
                                        <% } %>

                                          <% if (course.isDelete) { %>
                                            <a href="/admin/course-delete/<%= course.id %>"
                                              class="btn btn-outline-danger btn-sm"
                                              onclick="return confirm('Are you sure?');">
                                              <i class="fas fa-trash"></i>
                                            </a>
                                            <% } %>

                                              <% } %>
                                </div>


                              </div>
                              <% if (activeType==='trashed' ) { %>
                                <span class="badge badge-danger mt-3">Deleted at <%= course.deleted_at %></span>
                                <% } %>
                            </div>
                            <p>Created by <%= course.created_by_name %>
                            </p>
                          </div>
                        </div>
                      </div>
                      <% }); %>
                  </div>

                  <!-- View More Button -->
                  <% if (customers.length > 6) { %>
                  <div class="text-center my-4">
                    <button id="viewMoreBtn" class="btn btn-lg rounded-pill">
                      <i class="fas fa-plus-circle me-2"></i>View More Courses
                    </button>
                  </div>
                  <% } %>

                  <!-- Save Order Button -->

                  <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../layouts/footer') %>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- jQuery UI (adds .sortable and other UI functions) -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
      .ui-state-highlight {
        height: 200px;
        background-color: #e9ecef;
        border: 2px dashed #007bff;
        margin-bottom: 1rem;
      }
    </style>
    <!-- Drag & Drop Script -->
    <script>
      $(function () {
        $('#sortable').sortable({
          placeholder: 'ui-state-highlight'
        });

        $('#saveOrder').on('click', function () {
          const order = [];
          $('.course-item').each(function (index) {
            order.push({
              id: $(this).data('id'),
              sort_order: index + 1
            });
          });
          console.log("Showing here but not in controller");
          console.log(order);

          $.ajax({
            url: '/admin/course-sort-order',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ order }),
            success: function (res) {
              alert('Sort order updated successfully!');
              location.reload();
            },
            error: function () {
              alert('Error updating sort order.');
            }
          });
        });
      });
    </script>
    <script>
      $(function () {
        $("#sortable").sortable({
          placeholder: "ui-state-highlight",
          items: ".course-item"
        });
      });
    </script>
    <!-- Highlight style -->
    <style>
      .ui-state-highlight {
        height: 150px;
        background-color: #e9ecef;
        border: 2px dashed #007bff;
        margin-bottom: 1rem;
      }
    </style>
    <script>
      $(function () {
        if ($.fn.sortable) {
          $('#sortable').sortable({
            placeholder: 'ui-state-highlight',
            items: '.course-item'
          });
        } else {
          console.error("❌ jQuery UI not loaded. $('#sortable').sortable() is undefined.");
        }
      });

    </script>

    <script>

      const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
      const bulkRestoreBtn = document.getElementById("bulkRestoreBtn");
      const checkboxes = document.querySelectorAll(".bulk-checkbox");
      const selectAll = document.getElementById("selectAll");

      function updateBulkButtons() {
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        if (bulkDeleteBtn) bulkDeleteBtn.disabled = !anyChecked;
        if (bulkRestoreBtn) bulkRestoreBtn.disabled = !anyChecked;
      }

      checkboxes.forEach(cb => cb.addEventListener("change", updateBulkButtons));
      selectAll.addEventListener("change", function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkButtons();
      });

      async function bulkAction(endpoint, actionName) {
        const selectedIds = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        if (!selectedIds.length) return;
        if (!confirm(`Are you sure you want to ${actionName} selected courses?`)) return;

        try {
          const response = await fetch(`/admin/course/${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: selectedIds })
          });
          const result = await response.json();
          alert(result.message);
          if (result.success) location.reload();
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      }

      if (bulkDeleteBtn) bulkDeleteBtn.addEventListener("click", () => bulkAction("bulk-delete", "delete"));
      if (bulkRestoreBtn) bulkRestoreBtn.addEventListener("click", () => bulkAction("bulk-restore", "restore"));

    </script>


    <script>
      document.getElementById('exportBtn').addEventListener('click', async function (e) {
        e.preventDefault();
        try {
          const response = await fetch('/admin/course/export', { method: 'POST' });
          if (!response.ok) throw new Error('Failed to export');

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');

          // Generate filename with current local date-time
          const now = new Date();
          const pad = (n) => n.toString().padStart(2, '0');
          const timestamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;

          a.href = url;
          a.download = `course_export_${timestamp}.csv`; // dynamic filename
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url); // clean up
        } catch (err) {
          alert(err.message);
        }
      });
    </script>

    <!-- View More Courses Functionality -->
    <script>
      $(document).ready(function() {
        let currentlyVisible = 6;
        const loadMoreCount = 12;
        const allCourses = $('.course-item');
        const totalCourses = allCourses.length;
        const viewMoreBtn = $('#viewMoreBtn');

        function updateButtonText() {
          const hiddenCount = totalCourses - currentlyVisible;
          if (hiddenCount > 0) {
            const toShow = Math.min(loadMoreCount, hiddenCount);
            viewMoreBtn.html(`<i class="fas fa-plus-circle me-2"></i>View ${toShow} More Courses`);
          }
        }

        // Initialize button text
        if (totalCourses > 6) {
          updateButtonText();
        }

        viewMoreBtn.on('click', function() {
          const hiddenCourses = $('.course-item.hidden');
          const coursesToShow = hiddenCourses.slice(0, loadMoreCount);
          
          // Show courses with fade-in animation
          coursesToShow.each(function(index) {
            const course = $(this);
            setTimeout(function() {
              course.removeClass('hidden').hide().fadeIn(400);
            }, index * 50);
          });

          currentlyVisible += coursesToShow.length;

          // Update or hide button
          if (currentlyVisible >= totalCourses) {
            viewMoreBtn.fadeOut(300);
          } else {
            updateButtonText();
          }
        });
      });
    </script>